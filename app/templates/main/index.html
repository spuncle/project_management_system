{% extends "base.html" %}

{% block content %}
<datalist id="personnel-options">
    {% for person in personnel_list %}
        <option value="{{ person.name }}">
    {% endfor %}
</datalist>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h3 class="mb-2 mb-md-0">
        {{ page_main_title }} 
        <small class="text-muted fw-normal fs-6">{{ page_date_range }}</small>
    </h3>
    <div class="d-flex align-items-center flex-wrap">
        <div class="btn-group me-2 mb-2 mb-md-0" role="group">
            <a href="{{ url_for('main.index', start_date=prev_week) }}" class="btn btn-outline-secondary">&laquo; 上一周</a>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary {% if is_current_week %}active{% endif %}">当前周</a>
            <a href="{{ url_for('main.index', start_date=next_week) }}" class="btn btn-outline-secondary">下一周 &raquo;</a>
        </div>
        <form action="{{ url_for('main.export_excel') }}" method="POST" class="mb-2 mb-md-0">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="start_date" value="{{ week_dates[0].strftime('%Y-%m-%d') }}">
            <button type="submit" class="btn btn-success"><i class="bi bi-file-earmark-excel"></i> 导出 Excel</button>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                {% for day in week_dates %}
                    <th class="text-center" style="width: 14.28%;">
                        星期{{ ['一', '二', '三', '四', '五', '六', '日'][day.weekday()] }}<br>
                        <small>{{ day.strftime('%Y-%m-%d') }}</small>
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
            {% for day in week_dates %}
                <td class="align-top" style="vertical-align: top!important;">
                    <div class="task-list-container" data-date="{{ day.strftime('%Y-%m-%d') }}" id="task-list-{{ day.strftime('%Y%m%d') }}">
                        {% for task in schedule_by_day[day] %}
                        <div class="task-card" data-task-id="{{ task.id }}" data-task-version="{{ task.version }}">
                            <div class="task-content">{{ task.content }}</div>
                            <div class="personnel-tags">
                                {% for assignment in task.assignments %}
                                <span class="personnel-tag">{{ assignment.personnel_name }}</span>
                                {% endfor %}
                            </div>
                            <div class="task-footer">
                                {# --- 【修改】移除了 ID 显示 --- #}
                                <small class="text-muted"></small> 
                                {% if current_user.is_admin or current_user.can_edit or current_user.can_delete %}
                                <div class="task-controls">
                                    {% if current_user.is_admin or current_user.can_edit %}
                                    <button class="btn btn-sm btn-light py-0 px-1 edit-task-btn" data-bs-toggle="modal" data-bs-target="#taskModal" data-task-id="{{ task.id }}"><i class="bi bi-pencil-fill"></i></button>
                                    {% endif %}
                                    {% if current_user.is_admin or current_user.can_delete %}
                                    <button class="btn btn-sm btn-light py-0 px-1 delete-task-btn" data-task-id="{{ task.id }}"><i class="bi bi-trash-fill"></i></button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not schedule_by_day[day] %}
                            <p class="empty-day-placeholder">(空)</p>
                        {% endif %}
                    </div>
                    
                    {% if current_user.is_admin or current_user.can_add %}
                    <div class="text-center mt-2">
                        <button class="btn btn-sm btn-light w-100 add-task-btn" data-bs-toggle="modal" data-bs-target="#taskModal" data-date="{{ day.strftime('%Y-%m-%d') }}">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    {% endif %}
                </td>
            {% endfor %}
            </tr>
        </tbody>
    </table>
</div>

<script>
    const USER_CAN_EDIT = {{ 'true' if current_user.is_admin or current_user.can_edit else 'false' }};
    const PERSONNEL_WHITELIST = {{ personnel_list|map(attribute='name')|list|tojson }};
</script>
{% endblock %}