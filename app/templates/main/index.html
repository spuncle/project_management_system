{% extends "base.html" %}

{% block content %}
<datalist id="personnel-options">
    {% for person in personnel_list %}
        <option value="{{ person.name }}">
    {% endfor %}
</datalist>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h3 class="mb-2 mb-md-0">{{ page_title }}</h3>
    <div class="d-flex align-items-center flex-wrap">
        <div class="btn-group me-2 mb-2 mb-md-0" role="group">
            <a href="{{ url_for('main.index', start_date=prev_week) }}" class="btn btn-outline-secondary">&laquo; 上一周</a>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary {% if is_current_week %}active{% endif %}">当前周</a>
            <a href="{{ url_for('main.index', start_date=next_week) }}" class="btn btn-outline-secondary">下一周 &raquo;</a>
        </div>
        <button class="btn btn-primary me-2 mb-2 mb-md-0" data-bs-toggle="modal" data-bs-target="#addTaskModal">
            <i class="bi bi-plus-lg"></i> 添加多日任务
        </button>
        <form action="{{ url_for('main.export_excel') }}" method="POST" class="mb-2 mb-md-0">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="start_date" value="{{ week_dates[0].strftime('%Y-%m-%d') }}">
            <button type="submit" class="btn btn-success"><i class="bi bi-file-earmark-excel"></i> 导出 Excel</button>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                {% for day in week_dates %}
                    <th class="text-center" style="width: 14.28%;">
                        星期{{ ['一', '二', '三', '四', '五', '六', '日'][day.weekday()] }}<br>
                        <small>{{ day.strftime('%Y-%m-%d') }}</small>
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
            {% for day in week_dates %}
                <td class="align-top" style="min-width: 180px; vertical-align: top!important;">
                    <div class="task-list-container" data-date="{{ day.strftime('%Y-%m-%d') }}">
                        {% for task in schedule_by_day[day] %}
                        <div class="task-card" data-task-id="{{ task.id }}">
                            <div class="task-content">{{ task.content }}</div>
                            <div class="task-footer">
                                <small class="text-muted"><i class="bi bi-person"></i> {{ task.personnel }}</small>
                                <div class="task-controls">
                                    <button class="btn btn-sm btn-light py-0 px-1 edit-task-btn" data-bs-toggle="modal" data-bs-target="#editTaskModal" data-task-id="{{ task.id }}"><i class="bi bi-pencil-fill"></i></button>
                                    <form action="{{ url_for('main.delete_task', task_id=task.id) }}" method="POST" class="d-inline" onsubmit="return confirm('确定要删除此任务吗？');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-sm btn-light py-0 px-1"><i class="bi bi-trash-fill"></i></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-2">
                        <button class="btn btn-sm btn-light w-100 add-single-day-btn" data-bs-toggle="modal" data-bs-target="#addSingleDayTaskModal" data-date="{{ day.strftime('%Y-%m-%d') }}">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </td>
            {% endfor %}
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}