{% extends "base.html" %}
{% block content %}
<datalist id="personnel-options">
    {% for person in personnel_list %}
        <option value="{{ person.name }}">
    {% endfor %}
</datalist>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h3 class="mb-2 mb-md-0">
        {{ page_main_title }} 
        <small class="text-muted fw-normal fs-6">{{ page_date_range }}</small>
    </h3>
    <div class="d-flex align-items-center flex-wrap">
        <div class="btn-group me-2 mb-2 mb-md-0" role="group">
            <a href="{{ url_for('main.index', start_date=prev_week) }}" class="btn btn-outline-secondary">&laquo; 上一周</a>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary {% if is_current_week %}active{% endif %}">当前周</a>
            <a href="{{ url_for('main.index', start_date=next_week) }}" class="btn btn-outline-secondary">下一周 &raquo;</a>
        </div>
        <form action="{{ url_for('main.export_excel') }}" method="POST" class="mb-2 mb-md-0">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="start_date" value="{{ week_dates[0].strftime('%Y-%m-%d') }}">
            <button type="submit" class="btn btn-success"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel" viewBox="0 0 16 16"><path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.64L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 1A1.5 1.5 0 0 0 8 2.5v1.518l1.767-2.121.733.614Z"/></svg> 导出 Excel</button>
        </form>
    </div>
</div>
<div class="table-responsive">
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                {% for day in week_dates %}
                    <th class="text-center" style="width: 14.28%;">
                        星期{{ ['一', '二', '三', '四', '五', '六', '日'][day.weekday()] }}<br>
                        <small>{{ day.strftime('%Y-%m-%d') }}</small>
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
            {% for day in week_dates %}
                <td class="align-top" style="vertical-align: top!important;">
                    <div class="task-list-container" data-date="{{ day.strftime('%Y-%m-%d') }}" id="task-list-{{ day.strftime('%Y%m%d') }}">
                        {% for task in schedule_by_day[day] %}
                        {% set has_controls = current_user.is_admin or current_user.can_edit or current_user.can_delete %}
                        <div class="task-card {% if has_controls %}task-card-interactive{% endif %}" data-task-id="{{ task.id }}" data-task-version="{{ task.version }}">
                            <div class="task-content">{{ task.content }}</div>
                            <div class="task-footer">
                                <div class="personnel-display">
                                    <div class="personnel-tags">
                                        {% for assignment in task.assignments %}
                                        <span class="personnel-tag" title="{{ assignment.personnel_name }}">{{ assignment.personnel_name }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% if has_controls %}
                                <div class="task-controls-hover">
                                    {% if current_user.is_admin or current_user.can_edit %}
                                    <button class="btn btn-sm btn-light py-0 px-1 edit-task-btn" data-bs-toggle="modal" data-bs-target="#taskModal" data-task-id="{{ task.id }}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></button>
                                    {% endif %}
                                    {% if current_user.is_admin or current_user.can_delete %}
                                    <button class="btn btn-sm btn-light py-0 px-1 delete-task-btn" data-task-id="{{ task.id }}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg></button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not schedule_by_day[day] %}
                            <p class="empty-day-placeholder">(空)</p>
                        {% endif %}
                    </div>
                    
                    {% if current_user.is_admin or current_user.can_add %}
                    <div class="text-center mt-2">
                        <button class="btn btn-sm btn-light w-100 add-task-btn" data-bs-toggle="modal" data-bs-target="#taskModal" data-date="{{ day.strftime('%Y-%m-%d') }}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                    </div>
                    {% endif %}
                </td>
            {% endfor %}
            </tr>
        </tbody>
    </table>
</div>
<script>
    const USER_CAN_EDIT = {{ 'true' if current_user.is_admin or current_user.can_edit else 'false' }};
    const PERSONNEL_WHITELIST = {{ personnel_list|map(attribute='name')|list|tojson }};
</script>
{% endblock %}