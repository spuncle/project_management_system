{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>生成新邀请码</h4>
            </div>
            <div class="card-body">
                <p>点击下方按钮来生成一个新的、未使用的邀请码。</p>
                <form method="POST">
                    {{ form.hidden_tag() }}
                    {{ form.submit(class="btn btn-primary") }}
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <h4>未使用的邀请码</h4>
        {% if codes %}
        <div class="list-group">
            {% for code in codes %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <code id="code-{{ code.id }}">{{ code.code }}</code>
                    <button class="btn btn-sm btn-outline-secondary copy-btn" data-code-id="code-{{ code.id }}">复制</button>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">当前没有未使用的邀请码。</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const codeId = this.dataset.codeId;
            const codeElement = document.getElementById(codeId);
            const codeToCopy = codeElement.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                // 首选方案：现代、安全的 Clipboard API
                navigator.clipboard.writeText(codeToCopy).then(() => {
                    showCopySuccess(this);
                }).catch(err => {
                    fallbackCopyText(codeToCopy, this); // API失败则使用备用方案
                });
            } else {
                // 备用方案：用于 HTTP 或旧版浏览器
                fallbackCopyText(codeToCopy, this);
            }
        });
    });

    function showCopySuccess(button) {
        const originalText = button.textContent;
        button.textContent = '已复制!';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 1500);
    }

    function fallbackCopyText(text, button) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if(successful) showCopySuccess(button);
            else alert('复制失败，请手动复制。');
        } catch (err) {
            alert('复制失败，您的浏览器可能不支持此功能。请手动复制。');
        }
        document.body.removeChild(textArea);
    }
});
</script>
{% endblock %}