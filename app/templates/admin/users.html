{% extends "base.html" %}

{% block content %}
<h3 class="mb-4">{{ title }}</h3>
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>管理员</th>
                <th>允许添加</th>
                <th>允许编辑</th>
                <th>允许删除</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input permission-toggle" type="checkbox" role="switch" 
                               data-user-id="{{ user.id }}" data-permission="is_admin" 
                               {% if user.is_admin %}checked{% endif %} {% if user.id == current_user.id %}disabled{% endif %}>
                    </div>
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input permission-toggle" type="checkbox" role="switch" 
                               data-user-id="{{ user.id }}" data-permission="can_add" 
                               {% if user.can_add %}checked{% endif %} {% if user.is_admin %}disabled{% endif %}>
                    </div>
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input permission-toggle" type="checkbox" role="switch" 
                               data-user-id="{{ user.id }}" data-permission="can_edit" 
                               {% if user.can_edit %}checked{% endif %} {% if user.is_admin %}disabled{% endif %}>
                    </div>
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input permission-toggle" type="checkbox" role="switch" 
                               data-user-id="{{ user.id }}" data-permission="can_delete" 
                               {% if user.can_delete %}checked{% endif %} {% if user.is_admin %}disabled{% endif %}>
                    </div>
                </td>
                <td>
                    {% if user.id != current_user.id %}
                    <div class="btn-group btn-group-sm">
                        <form action="{{ url_for('admin.reset_password', user_id=user.id) }}" method="POST" class="d-inline" onsubmit="return confirm('您确定要重置该用户的密码吗？一个新的随机密码将会生成。');">
                             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                             <button type="submit" class="btn btn-outline-warning">重置密码</button>
                        </form>
                        <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST" class="d-inline" onsubmit="return confirm('警告：删除用户是不可逆操作，确定要删除吗？');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-danger">删除</button>
                        </form>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <small class="text-muted">提示：管理员默认拥有所有权限。为安全起见，不能修改或删除自己的账户。</small>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    document.querySelectorAll('.permission-toggle').forEach(toggle => {
        toggle.addEventListener('change', async function() {
            const userId = this.dataset.userId;
            const permission = this.dataset.permission;
            const value = this.checked;

            try {
                const response = await fetch(`/admin/api/user/${userId}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        permission: permission,
                        value: value
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    showToast(errorData.error || '更新权限失败。', 'danger');
                    this.checked = !value;
                } else {
                    showToast('权限已更新。页面将刷新...', 'success');
                    setTimeout(() => location.reload(), 1000);
                }

            } catch (error) {
                this.checked = !value;
                showToast('发生网络错误。', 'danger');
            }
        });
    });
});
</script>
{% endblock %}